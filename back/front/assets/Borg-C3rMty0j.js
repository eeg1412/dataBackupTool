import{h as S,i as H,j as I,r as n,o as r,a as s,c as o,t as i,F as _,k as D,n as W,g as q,d as C,w as R,e as z,v as G,f as J,m as K}from"./index-CgnhvXdC.js";import{_ as O}from"./Layout-CEfy5jPn.js";import{b as B,c as Q}from"./index-DkvgiuR8.js";import{g as X,s as Y}from"./borgPasswordDB-R24cjgOz.js";const Z={class:"space-y-4 sm:space-y-6"},ee={key:0,class:"flex justify-center py-12"},te={key:1,class:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 sm:p-6 text-center"},se={class:"text-yellow-800 dark:text-yellow-300 font-medium text-sm sm:text-base"},ae={key:2,class:"bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 p-4 rounded-lg text-sm sm:text-base"},re={key:0,class:"text-center py-12 text-gray-500 dark:text-gray-400"},oe={key:1,class:"space-y-3 sm:space-y-4"},le=["onClick"],ne={class:"flex items-center space-x-3 min-w-0"},de={class:"text-left min-w-0"},ie={class:"text-sm font-medium text-gray-900 dark:text-white truncate"},ce={class:"text-xs text-gray-500 dark:text-gray-400 truncate"},ue={key:0,class:"border-t border-gray-200 dark:border-gray-700"},ye={key:0,class:"flex justify-center py-6"},ge={key:1,class:"px-4 sm:px-5 py-4 text-red-600 dark:text-red-400 text-sm"},xe=["onClick"],pe={key:2,class:"px-4 sm:px-5 py-4 text-gray-500 dark:text-gray-400 text-sm text-center"},ve={key:3,class:"divide-y divide-gray-100 dark:divide-gray-700"},me={class:"min-w-0 flex-1"},he={class:"text-xs sm:text-sm font-medium text-gray-900 dark:text-white truncate"},fe={class:"text-xs text-gray-500 dark:text-gray-400"},be=["onClick","disabled"],we={class:"bg-white dark:bg-gray-800 rounded-xl shadow-xl p-5 sm:p-6 max-w-sm w-full"},ke={class:"text-sm text-gray-500 dark:text-gray-400 mb-4 truncate"},_e={key:0,class:"text-xs text-red-500 dark:text-red-400 mb-3"},Ce={class:"flex items-center mt-3 cursor-pointer"},Be={class:"flex justify-end space-x-3 mt-5"},Pe=["disabled"],Re={__name:"Borg",setup(Me){const f=n(!0),p=n(""),P=n(!0),M=n(""),b=n([]),v=n(""),u=n(!1),y=n(null),g=n(""),m=n(!1),$=n(null),w=n("");let d=null;S(async()=>{await N()});async function N(){f.value=!0,p.value="";try{const e=await B.repos();if(!e.data.available){P.value=!1,M.value=e.data.message;return}b.value=e.data.repos.map(t=>({...t,expanded:!1,loading:!1,error:"",archives:null,passphrase:"",passphraseReady:!1,needsPassword:!1}))}catch(e){p.value=e.response?.data?.error||"加载 Borg 仓库失败"}finally{f.value=!1}}function k(e,t=""){return new Promise(a=>{y.value=e,g.value="",m.value=!1,w.value=t,u.value=!0,d=a,K(()=>{$.value?.focus()})})}function j(){u.value=!1,d&&(d(null),d=null)}function L(){const e=y.value;u.value=!1,e&&(e.passphrase="",e.passphraseReady=!0),d&&(d(""),d=null)}async function T(){const e=g.value,t=m.value,a=y.value;if(u.value=!1,t&&a)try{await Y(a.path,e)}catch(l){console.error("保存密码失败:",l)}a&&(a.passphrase=e,a.passphraseReady=!0),d&&(d(e),d=null)}async function A(e){if(e.expanded=!e.expanded,e.expanded&&!e.archives){let t=null;try{t=await X(e.path)}catch{}if(t)e.passphrase=t,e.passphraseReady=!0,await h(e);else{if(await k(e)===null){e.expanded=!1;return}await h(e)}}}async function h(e){e.loading=!0,e.error="",e.needsPassword=!1;try{const t=await B.archives(e.path,e.passphrase||"");e.archives=t.data.archives}catch(t){const a=t.response?.data?.error||"加载存档列表失败";t.response?.status===403&&a.includes("密码")?(e.needsPassword=!0,e.error="密码错误或该仓库需要密码",await k(e,"密码错误，请重新输入正确的密码")!==null&&await h(e)):e.error=a}finally{e.loading=!1}}function E(e){if(!e)return"";try{return new Date(e).toLocaleString("zh-CN")}catch{return e}}async function U(e,t){const a=`${e.path}::${t}`;v.value=a;try{const l=await B.prepareDownload(e.path,t,e.passphrase||""),c=Q(l.data),V=l.data.archiveName||`archive-${t}`,x=document.createElement("a");x.href=c,x.download=`${V}.tar.gz`,document.body.appendChild(x),x.click(),document.body.removeChild(x)}catch(l){const c=l.response?.data?.error||"准备下载失败";alert(c),console.error("下载失败:",l)}finally{setTimeout(()=>{v.value=""},2e3)}}async function F(e){await k(e,"")!==null&&(e.archives=null,await h(e))}return(e,t)=>(r(),H(O,null,{default:I(()=>[s("div",Z,[t[10]||(t[10]=s("div",{class:"flex items-center justify-between"},[s("h2",{class:"text-lg sm:text-xl font-semibold text-gray-900 dark:text-white"}," Borg 备份 ")],-1)),f.value?(r(),o("div",ee,[...t[2]||(t[2]=[s("svg",{class:"animate-spin h-8 w-8 text-blue-600",fill:"none",viewBox:"0 0 24 24"},[s("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),s("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})],-1)])])):P.value?p.value?(r(),o("div",ae,i(p.value),1)):(r(),o(_,{key:3},[b.value.length===0?(r(),o("div",re,[...t[4]||(t[4]=[s("p",null,"没有配置任何 Borg 仓库",-1)])])):(r(),o("div",oe,[(r(!0),o(_,null,D(b.value,a=>(r(),o("div",{key:a.path,class:"bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden"},[s("button",{onClick:l=>A(a),class:"w-full px-4 sm:px-5 py-3 sm:py-4 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"},[s("div",ne,[t[5]||(t[5]=s("div",{class:"p-1.5 sm:p-2 bg-green-50 dark:bg-green-900/30 rounded-lg shrink-0"},[s("svg",{class:"w-4 h-4 sm:w-5 sm:h-5 text-green-600 dark:text-green-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"})])],-1)),s("div",de,[s("p",ie,i(a.name),1),s("p",ce,i(a.path),1)])]),(r(),o("svg",{class:W(["w-5 h-5 text-gray-400 transition-transform shrink-0 ml-2",{"rotate-180":a.expanded}]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[...t[6]||(t[6]=[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)])],2))],8,le),a.expanded?(r(),o("div",ue,[a.loading?(r(),o("div",ye,[...t[7]||(t[7]=[s("svg",{class:"animate-spin h-6 w-6 text-blue-600",fill:"none",viewBox:"0 0 24 24"},[s("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),s("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})],-1)])])):a.error?(r(),o("div",ge,[q(i(a.error)+" ",1),s("button",{onClick:l=>F(a),class:"ml-2 text-blue-600 dark:text-blue-400 hover:underline"}," 重新输入密码 ",8,xe)])):a.archives&&a.archives.length===0?(r(),o("div",pe," 该仓库没有存档 ")):(r(),o("div",ve,[(r(!0),o(_,null,D(a.archives,(l,c)=>(r(),o("div",{key:l.name,class:"flex items-center justify-between px-4 sm:px-5 py-2.5 sm:py-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"},[s("div",me,[s("p",he,i(l.name),1),s("p",fe,i(E(l.start)),1)]),s("button",{onClick:V=>U(a,c),disabled:v.value===`${a.path}::${c}`,class:"ml-2 sm:ml-3 px-2.5 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors disabled:opacity-50 shrink-0"},i(v.value===`${a.path}::${c}`?"准备中...":"下载"),9,be)]))),128))]))])):C("",!0)]))),128))]))],64)):(r(),o("div",te,[t[3]||(t[3]=s("svg",{class:"mx-auto h-10 w-10 text-yellow-500 mb-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),s("p",se,i(M.value),1)])),u.value?(r(),o("div",{key:4,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 px-4",onClick:R(j,["self"])},[s("div",we,[t[9]||(t[9]=s("h3",{class:"text-lg font-semibold text-gray-900 dark:text-white mb-1"}," 输入仓库密码 ",-1)),s("p",ke,i(y.value?.name||y.value?.path),1),w.value?(r(),o("p",_e,i(w.value),1)):C("",!0),s("form",{onSubmit:R(T,["prevent"])},[z(s("input",{ref_key:"passwordInput",ref:$,"onUpdate:modelValue":t[0]||(t[0]=a=>g.value=a),type:"password",autocomplete:"off",class:"w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition text-sm",placeholder:"Borg 仓库密码（无密码可留空）"},null,512),[[G,g.value]]),s("label",Ce,[z(s("input",{"onUpdate:modelValue":t[1]||(t[1]=a=>m.value=a),type:"checkbox",class:"w-4 h-4 text-blue-600 bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500"},null,512),[[J,m.value]]),t[8]||(t[8]=s("span",{class:"ml-2 text-sm text-gray-600 dark:text-gray-400"},"保存密码到浏览器",-1))]),s("div",Be,[s("button",{type:"button",onClick:j,class:"px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"}," 取消 "),s("button",{type:"button",onClick:L,class:"px-4 py-2 text-sm text-gray-600 dark:text-gray-400 border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"}," 无密码 "),s("button",{type:"submit",disabled:!g.value,class:"px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors disabled:opacity-50"}," 确认 ",8,Pe)])],32)])])):C("",!0)])]),_:1}))}};export{Re as default};
