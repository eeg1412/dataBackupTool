import{h as Y,i as Z,j as ee,r as d,o,a as s,c as l,t as c,d as P,F as N,k as A,n as te,g as ae,w as E,e as L,v as se,f as re,m as oe}from"./index-1WJulIZi.js";import{_ as le}from"./Layout-BRAVM_WB.js";import{b as y,c as R}from"./index-C5w0Yef5.js";import{g as ne,a as U,s as de}from"./borgPasswordDB-Caho0Vp_.js";const ie={class:"space-y-4 sm:space-y-6"},ce={class:"flex items-center justify-between flex-wrap gap-2"},ue=["disabled"],he={key:0,class:"flex justify-center py-12"},pe={key:1,class:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 sm:p-6 text-center"},ye={class:"text-yellow-800 dark:text-yellow-300 font-medium text-sm sm:text-base"},ve={key:2,class:"bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 p-4 rounded-lg text-sm sm:text-base"},ge={key:0,class:"text-center py-12 text-gray-500 dark:text-gray-400"},me={key:1,class:"space-y-3 sm:space-y-4"},xe=["onClick"],be={class:"flex items-center space-x-3 min-w-0"},we={class:"text-left min-w-0"},fe={class:"text-sm font-medium text-gray-900 dark:text-white truncate"},ke={class:"text-xs text-gray-500 dark:text-gray-400 truncate"},_e={key:0,class:"border-t border-gray-200 dark:border-gray-700"},Ce={key:0,class:"flex justify-center py-6"},$e={key:1,class:"px-4 sm:px-5 py-4 text-red-600 dark:text-red-400 text-sm"},Pe=["onClick"],Be={key:2,class:"px-4 sm:px-5 py-4 text-gray-500 dark:text-gray-400 text-sm text-center"},De={key:3},Me={class:"px-4 sm:px-5 py-2.5 bg-gray-50 dark:bg-gray-800/50 border-b border-gray-100 dark:border-gray-700"},je=["onClick","disabled"],Ne={class:"divide-y divide-gray-100 dark:divide-gray-700"},Re={class:"min-w-0 flex-1"},ze={class:"text-xs sm:text-sm font-medium text-gray-900 dark:text-white truncate"},Ve={class:"text-xs text-gray-500 dark:text-gray-400"},Te=["onClick","disabled"],Ae={class:"bg-white dark:bg-gray-800 rounded-xl shadow-xl p-5 sm:p-6 max-w-sm w-full"},Ee={class:"text-sm text-gray-500 dark:text-gray-400 mb-4 truncate"},Le={key:0,class:"text-xs text-red-500 dark:text-red-400 mb-3"},Ue={class:"flex items-center mt-3 cursor-pointer"},We={class:"flex justify-end space-x-3 mt-5"},Fe=["disabled"],Je={__name:"Borg",setup(Se){const B=d(!0),k=d(""),D=d(!0),z=d(""),v=d([]),h=d(""),g=d(!1),m=d(0),_=d(0),x=d(!1),b=d(null),w=d(""),C=d(!1),V=d(null),M=d("");let u=null;Y(async()=>{await W()});async function W(){B.value=!0,k.value="";try{const e=await y.repos();if(!e.data.available){D.value=!1,z.value=e.data.message;return}v.value=e.data.repos.map(t=>({...t,expanded:!1,loading:!1,error:"",archives:null,passphrase:"",passphraseReady:!1,needsPassword:!1}))}catch(e){k.value=e.response?.data?.error||"加载 Borg 仓库失败"}finally{B.value=!1}}function j(e,t=""){return new Promise(a=>{b.value=e,w.value="",C.value=!1,M.value=t,x.value=!0,u=a,oe(()=>{V.value?.focus()})})}function T(){x.value=!1,u&&(u(null),u=null)}function F(){const e=b.value;x.value=!1,e&&(e.passphrase="",e.passphraseReady=!0),u&&(u(""),u=null)}async function S(){const e=w.value,t=C.value,a=b.value;if(x.value=!1,t&&a)try{await de(a.path,e)}catch(r){console.error("保存密码失败:",r)}a&&(a.passphrase=e,a.passphraseReady=!0),u&&(u(e),u=null)}async function H(e){if(e.expanded=!e.expanded,e.expanded&&!e.archives){let t=null;try{t=await U(e.path)}catch{}if(t)e.passphrase=t,e.passphraseReady=!0,await $(e);else{if(await j(e)===null){e.expanded=!1;return}await $(e)}}}async function $(e){e.loading=!0,e.error="",e.needsPassword=!1;try{const t=await y.archives(e.path,e.passphrase||"");e.archives=t.data.archives}catch(t){const a=t.response?.data?.error||"加载存档列表失败";t.response?.status===403&&a.includes("密码")?(e.needsPassword=!0,e.error="密码错误或该仓库需要密码",await j(e,"密码错误，请重新输入正确的密码")!==null&&await $(e)):e.error=a}finally{e.loading=!1}}function I(e){if(!e)return"";try{return new Date(e).toLocaleString("zh-CN")}catch{return e}}async function q(e,t){const a=`${e.path}::${t}`;h.value=a;try{const r=await y.prepareDownload(e.path,t,e.passphrase||""),n=R(r.data),i=r.data.archiveName||`archive-${t}`,p=document.createElement("a");p.href=n,p.download=`${i}.tar.gz`,document.body.appendChild(p),p.click(),document.body.removeChild(p)}catch(r){const n=r.response?.data?.error||"准备下载失败";alert(n),console.error("下载失败:",r)}finally{setTimeout(()=>{h.value=""},2e3)}}async function G(e){if(!e.archives||e.archives.length===0){alert("该仓库没有存档");return}const t=`${e.path}::latest`;h.value=t;try{const a=await y.prepareDownload(e.path,0,e.passphrase||""),r=R(a.data),n=a.data.archiveName||"latest-archive",i=document.createElement("a");i.href=r,i.download=`${n}.tar.gz`,document.body.appendChild(i),i.click(),document.body.removeChild(i)}catch(a){const r=a.response?.data?.error||"准备下载失败";alert(r),console.error("下载最新备份失败:",a)}finally{setTimeout(()=>{h.value=""},2e3)}}async function J(e){await j(e,"")!==null&&(e.archives=null,await $(e))}async function K(){if(!g.value)try{const e=await ne(),t=v.value.filter(a=>e.some(r=>r.repoPath===a.path));if(t.length===0){alert("没有已保存密码的仓库");return}if(!confirm(`找到 ${t.length} 个已保存密码的仓库，确定要依次下载每个仓库的最新备份吗？`))return;g.value=!0,m.value=0,_.value=t.length;for(let a=0;a<t.length;a++){const r=t[a];m.value=a+1;try{const n=await U(r.path);if(!n){console.error(`仓库 ${r.name} 没有保存的密码`);continue}const i=await y.archives(r.path,n);if(!i.data.archives||i.data.archives.length===0){console.error(`仓库 ${r.name} 没有存档`);continue}const p=await y.prepareDownload(r.path,0,n),O=R(p.data),Q=p.data.archiveName||`${r.name}-latest`,f=document.createElement("a");f.href=O,f.download=`${Q}.tar.gz`,document.body.appendChild(f),f.click(),document.body.removeChild(f),await new Promise(X=>setTimeout(X,2e3))}catch(n){if(console.error(`下载仓库 ${r.name} 失败:`,n),!confirm(`下载仓库 ${r.name} 失败：${n.response?.data?.error||n.message}

是否继续下载其他仓库？`))break}}alert(`批量下载完成！成功: ${m.value}/${_.value}`)}catch(e){console.error("批量下载失败:",e),alert("批量下载失败: "+e.message)}finally{g.value=!1,m.value=0,_.value=0}}return(e,t)=>(o(),Z(le,null,{default:ee(()=>[s("div",ie,[s("div",ce,[t[2]||(t[2]=s("h2",{class:"text-lg sm:text-xl font-semibold text-gray-900 dark:text-white"}," Borg 备份 ",-1)),D.value&&v.value.length>0?(o(),l("button",{key:0,onClick:K,disabled:!!h.value||g.value,class:"px-3 py-1.5 text-xs sm:text-sm bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors disabled:opacity-50 whitespace-nowrap"},c(g.value?`批量下载中 (${m.value}/${_.value})`:"一键下载全部"),9,ue)):P("",!0)]),B.value?(o(),l("div",he,[...t[3]||(t[3]=[s("svg",{class:"animate-spin h-8 w-8 text-blue-600",fill:"none",viewBox:"0 0 24 24"},[s("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),s("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})],-1)])])):D.value?k.value?(o(),l("div",ve,c(k.value),1)):(o(),l(N,{key:3},[v.value.length===0?(o(),l("div",ge,[...t[5]||(t[5]=[s("p",null,"没有配置任何 Borg 仓库",-1)])])):(o(),l("div",me,[(o(!0),l(N,null,A(v.value,a=>(o(),l("div",{key:a.path,class:"bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden"},[s("button",{onClick:r=>H(a),class:"w-full px-4 sm:px-5 py-3 sm:py-4 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"},[s("div",be,[t[6]||(t[6]=s("div",{class:"p-1.5 sm:p-2 bg-green-50 dark:bg-green-900/30 rounded-lg shrink-0"},[s("svg",{class:"w-4 h-4 sm:w-5 sm:h-5 text-green-600 dark:text-green-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"})])],-1)),s("div",we,[s("p",fe,c(a.name),1),s("p",ke,c(a.path),1)])]),(o(),l("svg",{class:te(["w-5 h-5 text-gray-400 transition-transform shrink-0 ml-2",{"rotate-180":a.expanded}]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[...t[7]||(t[7]=[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)])],2))],8,xe),a.expanded?(o(),l("div",_e,[a.loading?(o(),l("div",Ce,[...t[8]||(t[8]=[s("svg",{class:"animate-spin h-6 w-6 text-blue-600",fill:"none",viewBox:"0 0 24 24"},[s("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),s("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})],-1)])])):a.error?(o(),l("div",$e,[ae(c(a.error)+" ",1),s("button",{onClick:r=>J(a),class:"ml-2 text-blue-600 dark:text-blue-400 hover:underline"}," 重新输入密码 ",8,Pe)])):a.archives&&a.archives.length===0?(o(),l("div",Be," 该仓库没有存档 ")):(o(),l("div",De,[s("div",Me,[s("button",{onClick:r=>G(a),disabled:h.value===`${a.path}::latest`,class:"w-full sm:w-auto px-3 py-1.5 text-xs sm:text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50"},c(h.value===`${a.path}::latest`?"准备中...":"下载最新备份"),9,je)]),s("div",Ne,[(o(!0),l(N,null,A(a.archives,(r,n)=>(o(),l("div",{key:r.name,class:"flex items-center justify-between px-4 sm:px-5 py-2.5 sm:py-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"},[s("div",Re,[s("p",ze,c(r.name),1),s("p",Ve,c(I(r.start)),1)]),s("button",{onClick:i=>q(a,n),disabled:h.value===`${a.path}::${n}`,class:"ml-2 sm:ml-3 px-2.5 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors disabled:opacity-50 shrink-0"},c(h.value===`${a.path}::${n}`?"准备中...":"下载"),9,Te)]))),128))])]))])):P("",!0)]))),128))]))],64)):(o(),l("div",pe,[t[4]||(t[4]=s("svg",{class:"mx-auto h-10 w-10 text-yellow-500 mb-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),s("p",ye,c(z.value),1)])),x.value?(o(),l("div",{key:4,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 px-4",onClick:E(T,["self"])},[s("div",Ae,[t[10]||(t[10]=s("h3",{class:"text-lg font-semibold text-gray-900 dark:text-white mb-1"}," 输入仓库密码 ",-1)),s("p",Ee,c(b.value?.name||b.value?.path),1),M.value?(o(),l("p",Le,c(M.value),1)):P("",!0),s("form",{onSubmit:E(S,["prevent"])},[L(s("input",{ref_key:"passwordInput",ref:V,"onUpdate:modelValue":t[0]||(t[0]=a=>w.value=a),type:"password",autocomplete:"off",class:"w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition text-sm",placeholder:"Borg 仓库密码（无密码可留空）"},null,512),[[se,w.value]]),s("label",Ue,[L(s("input",{"onUpdate:modelValue":t[1]||(t[1]=a=>C.value=a),type:"checkbox",class:"w-4 h-4 text-blue-600 bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500"},null,512),[[re,C.value]]),t[9]||(t[9]=s("span",{class:"ml-2 text-sm text-gray-600 dark:text-gray-400"},"保存密码到浏览器",-1))]),s("div",We,[s("button",{type:"button",onClick:T,class:"px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"}," 取消 "),s("button",{type:"button",onClick:F,class:"px-4 py-2 text-sm text-gray-600 dark:text-gray-400 border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"}," 无密码 "),s("button",{type:"submit",disabled:!w.value,class:"px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors disabled:opacity-50"}," 确认 ",8,Fe)])],32)])])):P("",!0)])]),_:1}))}};export{Je as default};
