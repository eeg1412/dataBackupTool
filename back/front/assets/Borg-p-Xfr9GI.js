import{h as S,i as U,j as F,r as n,o as r,a as s,c as o,t as i,F as k,k as $,n as N,g as H,d as _,w as j,e as V,v as W,f as q,m as G}from"./index-D_D1NxvD.js";import{_ as J}from"./Layout-BVgoVKe6.js";import{b as R,g as K}from"./index-Dm-C4vXQ.js";import{g as O,s as Q}from"./borgPasswordDB-R24cjgOz.js";const X={class:"space-y-4 sm:space-y-6"},Y={key:0,class:"flex justify-center py-12"},Z={key:1,class:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 sm:p-6 text-center"},ee={class:"text-yellow-800 dark:text-yellow-300 font-medium text-sm sm:text-base"},te={key:2,class:"bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 p-4 rounded-lg text-sm sm:text-base"},se={key:0,class:"text-center py-12 text-gray-500 dark:text-gray-400"},ae={key:1,class:"space-y-3 sm:space-y-4"},re=["onClick"],oe={class:"flex items-center space-x-3 min-w-0"},le={class:"text-left min-w-0"},ne={class:"text-sm font-medium text-gray-900 dark:text-white truncate"},de={class:"text-xs text-gray-500 dark:text-gray-400 truncate"},ie={key:0,class:"border-t border-gray-200 dark:border-gray-700"},ce={key:0,class:"flex justify-center py-6"},ue={key:1,class:"px-4 sm:px-5 py-4 text-red-600 dark:text-red-400 text-sm"},ye=["onClick"],xe={key:2,class:"px-4 sm:px-5 py-4 text-gray-500 dark:text-gray-400 text-sm text-center"},ge={key:3,class:"divide-y divide-gray-100 dark:divide-gray-700"},pe={class:"min-w-0 flex-1"},me={class:"text-xs sm:text-sm font-medium text-gray-900 dark:text-white truncate"},ve={class:"text-xs text-gray-500 dark:text-gray-400"},he=["onClick","disabled"],fe={class:"bg-white dark:bg-gray-800 rounded-xl shadow-xl p-5 sm:p-6 max-w-sm w-full"},be={class:"text-sm text-gray-500 dark:text-gray-400 mb-4 truncate"},we={key:0,class:"text-xs text-red-500 dark:text-red-400 mb-3"},ke={class:"flex items-center mt-3 cursor-pointer"},_e={class:"flex justify-end space-x-3 mt-5"},Ce=["disabled"],Ve={__name:"Borg",setup(Pe){const h=n(!0),g=n(""),C=n(!0),P=n(""),f=n([]),p=n(""),u=n(!1),y=n(null),x=n(""),m=n(!1),B=n(null),b=n("");let d=null;S(async()=>{await z()});async function z(){h.value=!0,g.value="";try{const e=await R.repos();if(!e.data.available){C.value=!1,P.value=e.data.message;return}f.value=e.data.repos.map(t=>({...t,expanded:!1,loading:!1,error:"",archives:null,passphrase:"",passphraseReady:!1,needsPassword:!1}))}catch(e){g.value=e.response?.data?.error||"加载 Borg 仓库失败"}finally{h.value=!1}}function w(e,t=""){return new Promise(a=>{y.value=e,x.value="",m.value=!1,b.value=t,u.value=!0,d=a,G(()=>{B.value?.focus()})})}function M(){u.value=!1,d&&(d(null),d=null)}function D(){const e=y.value;u.value=!1,e&&(e.passphrase="",e.passphraseReady=!0),d&&(d(""),d=null)}async function L(){const e=x.value,t=m.value,a=y.value;if(u.value=!1,t&&a)try{await Q(a.path,e)}catch(l){console.error("保存密码失败:",l)}a&&(a.passphrase=e,a.passphraseReady=!0),d&&(d(e),d=null)}async function T(e){if(e.expanded=!e.expanded,e.expanded&&!e.archives){let t=null;try{t=await O(e.path)}catch{}if(t)e.passphrase=t,e.passphraseReady=!0,await v(e);else{if(await w(e)===null){e.expanded=!1;return}await v(e)}}}async function v(e){e.loading=!0,e.error="",e.needsPassword=!1;try{const t=await R.archives(e.path,e.passphrase||"");e.archives=t.data.archives}catch(t){const a=t.response?.data?.error||"加载存档列表失败";t.response?.status===403&&a.includes("密码")?(e.needsPassword=!0,e.error="密码错误或该仓库需要密码",await w(e,"密码错误，请重新输入正确的密码")!==null&&await v(e)):e.error=a}finally{e.loading=!1}}function A(e){if(!e)return"";try{return new Date(e).toLocaleString("zh-CN")}catch{return e}}async function E(e,t){const a=`${e.path}::${t}`;p.value=a;try{const l=await K("borg",{repo:e.path,archive:t,passphrase:e.passphrase||""}),c=document.createElement("a");c.href=l,c.download=`${t}.tar.gz`,document.body.appendChild(c),c.click(),document.body.removeChild(c)}catch(l){console.error("获取下载凭证失败:",l)}finally{setTimeout(()=>{p.value=""},2e3)}}async function I(e){await w(e,"")!==null&&(e.archives=null,await v(e))}return(e,t)=>(r(),U(J,null,{default:F(()=>[s("div",X,[t[10]||(t[10]=s("div",{class:"flex items-center justify-between"},[s("h2",{class:"text-lg sm:text-xl font-semibold text-gray-900 dark:text-white"}," Borg 备份 ")],-1)),h.value?(r(),o("div",Y,[...t[2]||(t[2]=[s("svg",{class:"animate-spin h-8 w-8 text-blue-600",fill:"none",viewBox:"0 0 24 24"},[s("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),s("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})],-1)])])):C.value?g.value?(r(),o("div",te,i(g.value),1)):(r(),o(k,{key:3},[f.value.length===0?(r(),o("div",se,[...t[4]||(t[4]=[s("p",null,"没有配置任何 Borg 仓库",-1)])])):(r(),o("div",ae,[(r(!0),o(k,null,$(f.value,a=>(r(),o("div",{key:a.path,class:"bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden"},[s("button",{onClick:l=>T(a),class:"w-full px-4 sm:px-5 py-3 sm:py-4 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"},[s("div",oe,[t[5]||(t[5]=s("div",{class:"p-1.5 sm:p-2 bg-green-50 dark:bg-green-900/30 rounded-lg shrink-0"},[s("svg",{class:"w-4 h-4 sm:w-5 sm:h-5 text-green-600 dark:text-green-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"})])],-1)),s("div",le,[s("p",ne,i(a.name),1),s("p",de,i(a.path),1)])]),(r(),o("svg",{class:N(["w-5 h-5 text-gray-400 transition-transform shrink-0 ml-2",{"rotate-180":a.expanded}]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[...t[6]||(t[6]=[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)])],2))],8,re),a.expanded?(r(),o("div",ie,[a.loading?(r(),o("div",ce,[...t[7]||(t[7]=[s("svg",{class:"animate-spin h-6 w-6 text-blue-600",fill:"none",viewBox:"0 0 24 24"},[s("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),s("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})],-1)])])):a.error?(r(),o("div",ue,[H(i(a.error)+" ",1),s("button",{onClick:l=>I(a),class:"ml-2 text-blue-600 dark:text-blue-400 hover:underline"}," 重新输入密码 ",8,ye)])):a.archives&&a.archives.length===0?(r(),o("div",xe," 该仓库没有存档 ")):(r(),o("div",ge,[(r(!0),o(k,null,$(a.archives,l=>(r(),o("div",{key:l.name,class:"flex items-center justify-between px-4 sm:px-5 py-2.5 sm:py-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"},[s("div",pe,[s("p",me,i(l.name),1),s("p",ve,i(A(l.start)),1)]),s("button",{onClick:c=>E(a,l.name),disabled:p.value===`${a.path}::${l.name}`,class:"ml-2 sm:ml-3 px-2.5 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors disabled:opacity-50 shrink-0"},i(p.value===`${a.path}::${l.name}`?"准备中...":"下载"),9,he)]))),128))]))])):_("",!0)]))),128))]))],64)):(r(),o("div",Z,[t[3]||(t[3]=s("svg",{class:"mx-auto h-10 w-10 text-yellow-500 mb-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),s("p",ee,i(P.value),1)])),u.value?(r(),o("div",{key:4,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 px-4",onClick:j(M,["self"])},[s("div",fe,[t[9]||(t[9]=s("h3",{class:"text-lg font-semibold text-gray-900 dark:text-white mb-1"}," 输入仓库密码 ",-1)),s("p",be,i(y.value?.name||y.value?.path),1),b.value?(r(),o("p",we,i(b.value),1)):_("",!0),s("form",{onSubmit:j(L,["prevent"])},[V(s("input",{ref_key:"passwordInput",ref:B,"onUpdate:modelValue":t[0]||(t[0]=a=>x.value=a),type:"password",autocomplete:"off",class:"w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition text-sm",placeholder:"Borg 仓库密码（无密码可留空）"},null,512),[[W,x.value]]),s("label",ke,[V(s("input",{"onUpdate:modelValue":t[1]||(t[1]=a=>m.value=a),type:"checkbox",class:"w-4 h-4 text-blue-600 bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500"},null,512),[[q,m.value]]),t[8]||(t[8]=s("span",{class:"ml-2 text-sm text-gray-600 dark:text-gray-400"},"保存密码到浏览器",-1))]),s("div",_e,[s("button",{type:"button",onClick:M,class:"px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"}," 取消 "),s("button",{type:"button",onClick:D,class:"px-4 py-2 text-sm text-gray-600 dark:text-gray-400 border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"}," 无密码 "),s("button",{type:"submit",disabled:!x.value,class:"px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors disabled:opacity-50"}," 确认 ",8,Ce)])],32)])])):_("",!0)])]),_:1}))}};export{Ve as default};
