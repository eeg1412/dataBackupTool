import{h as A,i as I,j as U,r as n,o as r,a as s,c as o,t as d,F as f,k as P,n as E,g as F,d as b,w as $,e as j,v as N,f as S,m as q}from"./index-XOcsfyQw.js";import{_ as G}from"./Layout-BfVAJuh5.js";import{b as V,g as H}from"./index-BsHt6FaX.js";import{s as J,g as K}from"./borgPasswordDB-R24cjgOz.js";const O={class:"space-y-4 sm:space-y-6"},Q={key:0,class:"flex justify-center py-12"},W={key:1,class:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 sm:p-6 text-center"},X={class:"text-yellow-800 dark:text-yellow-300 font-medium text-sm sm:text-base"},Y={key:2,class:"bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 p-4 rounded-lg text-sm sm:text-base"},Z={key:0,class:"text-center py-12 text-gray-500 dark:text-gray-400"},ee={key:1,class:"space-y-3 sm:space-y-4"},te=["onClick"],se={class:"flex items-center space-x-3 min-w-0"},ae={class:"text-left min-w-0"},re={class:"text-sm font-medium text-gray-900 dark:text-white truncate"},oe={class:"text-xs text-gray-500 dark:text-gray-400 truncate"},le={key:0,class:"border-t border-gray-200 dark:border-gray-700"},ne={key:0,class:"flex justify-center py-6"},de={key:1,class:"px-4 sm:px-5 py-4 text-red-600 dark:text-red-400 text-sm"},ie=["onClick"],ce={key:2,class:"px-4 sm:px-5 py-4 text-gray-500 dark:text-gray-400 text-sm text-center"},ue={key:3,class:"divide-y divide-gray-100 dark:divide-gray-700"},xe={class:"min-w-0 flex-1"},ge={class:"text-xs sm:text-sm font-medium text-gray-900 dark:text-white truncate"},ye={class:"text-xs text-gray-500 dark:text-gray-400"},pe=["onClick","disabled"],me={class:"bg-white dark:bg-gray-800 rounded-xl shadow-xl p-5 sm:p-6 max-w-sm w-full"},ve={class:"text-sm text-gray-500 dark:text-gray-400 mb-4 truncate"},he={class:"flex items-center mt-3 cursor-pointer"},fe={class:"flex justify-end space-x-3 mt-5"},be=["disabled"],Me={__name:"Borg",setup(ke){const m=n(!0),x=n(""),k=n(!0),w=n(""),v=n([]),g=n(""),y=n(!1),h=n(null),u=n(""),p=n(!1),_=n(null);let i=null;A(async()=>{await z()});async function z(){m.value=!0,x.value="";try{const e=await V.repos();if(!e.data.available){k.value=!1,w.value=e.data.message;return}v.value=e.data.repos.map(a=>({...a,expanded:!1,loading:!1,error:"",archives:null,passphrase:"",needsPassword:!1}))}catch(e){x.value=e.response?.data?.error||"加载 Borg 仓库失败"}finally{m.value=!1}}function C(e){return new Promise(a=>{h.value=e,u.value="",p.value=!1,y.value=!0,i=a,q(()=>{_.value?.focus()})})}function B(){y.value=!1,i&&(i(null),i=null)}async function D(){const e=u.value,a=p.value,t=h.value;if(y.value=!1,a&&t)try{await J(t.path,e)}catch(l){console.error("保存密码失败:",l)}t&&(t.passphrase=e),i&&(i(e),i=null)}async function L(e){e.expanded=!e.expanded,e.expanded&&!e.archives&&await M(e)}async function M(e){e.loading=!0,e.error="",e.needsPassword=!1;let a=e.passphrase;if(!a)try{const t=await K(e.path);t&&(a=t,e.passphrase=t)}catch{}try{const t=await V.archives(e.path,a);e.archives=t.data.archives}catch(t){const l=t.response?.data?.error||"加载存档列表失败";t.response?.status===403&&l.includes("密码")?(e.needsPassword=!0,e.error="该仓库需要密码才能访问",await C(e)&&await M(e)):e.error=l}finally{e.loading=!1}}function R(e){if(!e)return"";try{return new Date(e).toLocaleString("zh-CN")}catch{return e}}function T(e,a){const t=`${e.path}::${a}`;g.value=t;const l=H("borg",{repo:e.path,archive:a,passphrase:e.passphrase||""}),c=document.createElement("a");c.href=l,c.download=`${a}.tar.gz`,document.body.appendChild(c),c.click(),document.body.removeChild(c),setTimeout(()=>{g.value=""},2e3)}return(e,a)=>(r(),I(G,null,{default:U(()=>[s("div",O,[a[10]||(a[10]=s("div",{class:"flex items-center justify-between"},[s("h2",{class:"text-lg sm:text-xl font-semibold text-gray-900 dark:text-white"}," Borg 备份 ")],-1)),m.value?(r(),o("div",Q,[...a[2]||(a[2]=[s("svg",{class:"animate-spin h-8 w-8 text-blue-600",fill:"none",viewBox:"0 0 24 24"},[s("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),s("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})],-1)])])):k.value?x.value?(r(),o("div",Y,d(x.value),1)):(r(),o(f,{key:3},[v.value.length===0?(r(),o("div",Z,[...a[4]||(a[4]=[s("p",null,"没有配置任何 Borg 仓库",-1)])])):(r(),o("div",ee,[(r(!0),o(f,null,P(v.value,t=>(r(),o("div",{key:t.path,class:"bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden"},[s("button",{onClick:l=>L(t),class:"w-full px-4 sm:px-5 py-3 sm:py-4 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"},[s("div",se,[a[5]||(a[5]=s("div",{class:"p-1.5 sm:p-2 bg-green-50 dark:bg-green-900/30 rounded-lg shrink-0"},[s("svg",{class:"w-4 h-4 sm:w-5 sm:h-5 text-green-600 dark:text-green-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"})])],-1)),s("div",ae,[s("p",re,d(t.name),1),s("p",oe,d(t.path),1)])]),(r(),o("svg",{class:E(["w-5 h-5 text-gray-400 transition-transform shrink-0 ml-2",{"rotate-180":t.expanded}]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[...a[6]||(a[6]=[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)])],2))],8,te),t.expanded?(r(),o("div",le,[t.loading?(r(),o("div",ne,[...a[7]||(a[7]=[s("svg",{class:"animate-spin h-6 w-6 text-blue-600",fill:"none",viewBox:"0 0 24 24"},[s("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),s("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})],-1)])])):t.error?(r(),o("div",de,[F(d(t.error)+" ",1),t.needsPassword?(r(),o("button",{key:0,onClick:l=>C(t),class:"ml-2 text-blue-600 dark:text-blue-400 hover:underline"}," 输入密码重试 ",8,ie)):b("",!0)])):t.archives&&t.archives.length===0?(r(),o("div",ce," 该仓库没有存档 ")):(r(),o("div",ue,[(r(!0),o(f,null,P(t.archives,l=>(r(),o("div",{key:l.name,class:"flex items-center justify-between px-4 sm:px-5 py-2.5 sm:py-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"},[s("div",xe,[s("p",ge,d(l.name),1),s("p",ye,d(R(l.start)),1)]),s("button",{onClick:c=>T(t,l.name),disabled:g.value===`${t.path}::${l.name}`,class:"ml-2 sm:ml-3 px-2.5 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors disabled:opacity-50 shrink-0"},d(g.value===`${t.path}::${l.name}`?"准备中...":"下载"),9,pe)]))),128))]))])):b("",!0)]))),128))]))],64)):(r(),o("div",W,[a[3]||(a[3]=s("svg",{class:"mx-auto h-10 w-10 text-yellow-500 mb-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),s("p",X,d(w.value),1)])),y.value?(r(),o("div",{key:4,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 px-4",onClick:$(B,["self"])},[s("div",me,[a[9]||(a[9]=s("h3",{class:"text-lg font-semibold text-gray-900 dark:text-white mb-1"}," 输入仓库密码 ",-1)),s("p",ve,d(h.value?.path),1),s("form",{onSubmit:$(D,["prevent"])},[j(s("input",{ref_key:"passwordInput",ref:_,"onUpdate:modelValue":a[0]||(a[0]=t=>u.value=t),type:"password",required:"",autocomplete:"off",class:"w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition text-sm",placeholder:"Borg 仓库密码"},null,512),[[N,u.value]]),s("label",he,[j(s("input",{"onUpdate:modelValue":a[1]||(a[1]=t=>p.value=t),type:"checkbox",class:"w-4 h-4 text-blue-600 bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500"},null,512),[[S,p.value]]),a[8]||(a[8]=s("span",{class:"ml-2 text-sm text-gray-600 dark:text-gray-400"},"保存密码到浏览器",-1))]),s("div",fe,[s("button",{type:"button",onClick:B,class:"px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"}," 取消 "),s("button",{type:"submit",disabled:!u.value,class:"px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors disabled:opacity-50"}," 确认 ",8,be)])],32)])])):b("",!0)])]),_:1}))}};export{Me as default};
