import{h as te,i as ae,j as se,r as d,o as l,a as s,c as n,t as c,d as R,F as V,k as H,n as re,w as T,g as oe,e as I,v as le,f as ne,m as de}from"./index-B0d6AujN.js";import{_ as ie,u as ce}from"./Layout-DXucR0bO.js";import{b as g,c as A}from"./index-BDcExPYf.js";import{g as ue,a as E,s as he}from"./borgPasswordDB-Caho0Vp_.js";const pe={class:"space-y-4 sm:space-y-6"},ve={class:"flex items-center justify-between flex-wrap gap-2"},ye=["disabled"],ge={key:0,class:"flex justify-center py-12"},me={key:1,class:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 sm:p-6 text-center"},xe={class:"text-yellow-800 dark:text-yellow-300 font-medium text-sm sm:text-base"},we={key:2,class:"bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 p-4 rounded-lg text-sm sm:text-base"},fe={key:0,class:"text-center py-12 text-gray-500 dark:text-gray-400"},be={key:1,class:"space-y-3 sm:space-y-4"},ke={class:"px-4 sm:px-5 py-3 sm:py-4"},_e=["onClick"],Ce={class:"flex items-center space-x-3 min-w-0"},$e={class:"text-left min-w-0"},Pe={class:"text-sm font-medium text-gray-900 dark:text-white truncate"},Be={class:"text-xs text-gray-500 dark:text-gray-400 truncate"},Me=["onClick","disabled"],Re={key:0,class:"border-t border-gray-200 dark:border-gray-700"},De={key:0,class:"flex justify-center py-6"},je={key:1,class:"px-4 sm:px-5 py-4 text-red-600 dark:text-red-400 text-sm"},Ne=["onClick"],ze={key:2,class:"px-4 sm:px-5 py-4 text-gray-500 dark:text-gray-400 text-sm text-center"},Ve={key:3,class:"divide-y divide-gray-100 dark:divide-gray-700"},Te={class:"min-w-0 flex-1"},Ae={class:"text-xs sm:text-sm font-medium text-gray-900 dark:text-white truncate"},Ee={class:"text-xs text-gray-500 dark:text-gray-400"},Le=["onClick","disabled"],Ue={class:"bg-white dark:bg-gray-800 rounded-xl shadow-xl p-5 sm:p-6 max-w-sm w-full"},We={class:"text-sm text-gray-500 dark:text-gray-400 mb-4 truncate"},Fe={key:0,class:"text-xs text-red-500 dark:text-red-400 mb-3"},Se={class:"flex items-center mt-3 cursor-pointer"},He={class:"flex justify-end space-x-3 mt-5"},Ie=["disabled"],Qe={__name:"Borg",setup(qe){const{success:q,error:D,warning:L}=ce(),j=d(!0),$=d(""),N=d(!0),U=d(""),x=d([]),i=d(""),w=d(!1),f=d(0),P=d(0),b=d(!1),k=d(null),_=d(""),B=d(!1),W=d(null),z=d("");let u=null;te(async()=>{await G()});async function G(){j.value=!0,$.value="";try{const e=await g.repos();if(!e.data.available){N.value=!1,U.value=e.data.message;return}x.value=e.data.repos.map(a=>({...a,expanded:!1,loading:!1,error:"",archives:null,passphrase:"",passphraseReady:!1,needsPassword:!1}))}catch(e){$.value=e.response?.data?.error||"加载 Borg 仓库失败"}finally{j.value=!1}}function C(e,a=""){return new Promise(t=>{k.value=e,_.value="",B.value=!1,z.value=a,b.value=!0,u=t,de(()=>{W.value?.focus()})})}function F(){b.value=!1,u&&(u(null),u=null)}function J(){const e=k.value;b.value=!1,e&&(e.passphrase="",e.passphraseReady=!0),u&&(u(""),u=null)}async function K(){const e=_.value,a=B.value,t=k.value;if(b.value=!1,a&&t)try{await he(t.path,e)}catch(r){console.error("保存密码失败:",r)}t&&(t.passphrase=e,t.passphraseReady=!0),u&&(u(e),u=null)}async function O(e){if(e.expanded=!e.expanded,e.expanded&&!e.archives){let a=null;try{a=await E(e.path)}catch{}if(a)e.passphrase=a,e.passphraseReady=!0,await M(e);else{if(await C(e)===null){e.expanded=!1;return}await M(e)}}}async function M(e){e.loading=!0,e.error="",e.needsPassword=!1;try{const a=await g.archives(e.path,e.passphrase||"");e.archives=a.data.archives}catch(a){const t=a.response?.data?.error||"加载存档列表失败";a.response?.status===403&&t.includes("密码")?(e.needsPassword=!0,e.error="密码错误或该仓库需要密码",await C(e,"密码错误，请重新输入正确的密码")!==null&&await M(e)):e.error=t}finally{e.loading=!1}}function Q(e){if(!e)return"";try{return new Date(e).toLocaleString("zh-CN")}catch{return e}}async function X(e,a){const t=`${e.path}::${a}`;i.value=t;try{const r=await g.prepareDownload(e.path,a,e.passphrase||""),o=A(r.data),p=r.data.archiveName||`archive-${a}`,h=document.createElement("a");h.href=o,h.download=`${p}.tar.gz`,document.body.appendChild(h),h.click(),document.body.removeChild(h)}catch(r){const o=r.response?.data?.error||"准备下载失败";D(o),console.error("下载失败:",r)}finally{setTimeout(()=>{i.value=""},2e3)}}async function S(e){const a=`${e.path}::latest`;i.value=a;try{let t=e.passphrase||"";if(!e.passphraseReady){let m=null;try{m=await E(e.path)}catch{}if(m)t=m,e.passphrase=m,e.passphraseReady=!0;else{const v=await C(e);if(v===null){i.value="";return}t=v}}const r=await g.archives(e.path,t);if(!r.data.archives||r.data.archives.length===0){L("该仓库没有存档"),i.value="";return}const o=await g.prepareDownload(e.path,0,t),p=A(o.data),h=o.data.archiveName||"latest-archive",y=document.createElement("a");y.href=p,y.download=`${h}.tar.gz`,document.body.appendChild(y),y.click(),document.body.removeChild(y)}catch(t){const r=t.response?.data?.error||"准备下载失败";if(t.response?.status===403&&r.includes("密码")){const o=await C(e,"密码错误，请重新输入正确的密码");if(o!==null){e.passphrase=o,e.passphraseReady=!0,i.value="",await S(e);return}}else D(r),console.error("下载最新备份失败:",t)}finally{setTimeout(()=>{i.value=""},2e3)}}async function Y(e){await C(e,"")!==null&&(e.archives=null,await M(e))}async function Z(){if(!w.value)try{const e=await ue(),a=x.value.filter(t=>e.some(r=>r.repoPath===t.path));if(a.length===0){L("没有已保存密码的仓库");return}if(!confirm(`找到 ${a.length} 个已保存密码的仓库，确定要依次下载每个仓库的最新备份吗？`))return;w.value=!0,f.value=0,P.value=a.length;for(let t=0;t<a.length;t++){const r=a[t];f.value=t+1;try{const o=await E(r.path);if(!o){console.error(`仓库 ${r.name} 没有保存的密码`);continue}const p=await g.archives(r.path,o);if(!p.data.archives||p.data.archives.length===0){console.error(`仓库 ${r.name} 没有存档`);continue}const h=await g.prepareDownload(r.path,0,o),y=A(h.data),m=h.data.archiveName||`${r.name}-latest`,v=document.createElement("a");v.href=y,v.download=`${m}.tar.gz`,document.body.appendChild(v),v.click(),document.body.removeChild(v),await new Promise(ee=>setTimeout(ee,2e3))}catch(o){if(console.error(`下载仓库 ${r.name} 失败:`,o),!confirm(`下载仓库 ${r.name} 失败：${o.response?.data?.error||o.message}

是否继续下载其他仓库？`))break}}q(`批量下载完成！成功: ${f.value}/${P.value}`,4e3)}catch(e){console.error("批量下载失败:",e),D("批量下载失败: "+e.message)}finally{w.value=!1,f.value=0,P.value=0}}return(e,a)=>(l(),ae(ie,null,{default:se(()=>[s("div",pe,[s("div",ve,[a[2]||(a[2]=s("h2",{class:"text-lg sm:text-xl font-semibold text-gray-900 dark:text-white"}," Borg 备份 ",-1)),N.value&&x.value.length>0?(l(),n("button",{key:0,onClick:Z,disabled:!!i.value||w.value,class:"px-3 py-1.5 text-xs sm:text-sm bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors disabled:opacity-50 whitespace-nowrap"},c(w.value?`批量下载中 (${f.value}/${P.value})`:"一键下载全部"),9,ye)):R("",!0)]),j.value?(l(),n("div",ge,[...a[3]||(a[3]=[s("svg",{class:"animate-spin h-8 w-8 text-blue-600",fill:"none",viewBox:"0 0 24 24"},[s("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),s("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})],-1)])])):N.value?$.value?(l(),n("div",we,c($.value),1)):(l(),n(V,{key:3},[x.value.length===0?(l(),n("div",fe,[...a[5]||(a[5]=[s("p",null,"没有配置任何 Borg 仓库",-1)])])):(l(),n("div",be,[(l(!0),n(V,null,H(x.value,t=>(l(),n("div",{key:t.path,class:"bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden"},[s("div",ke,[s("button",{onClick:r=>O(t),class:"w-full flex items-center justify-between hover:opacity-80 transition-opacity"},[s("div",Ce,[a[6]||(a[6]=s("div",{class:"p-1.5 sm:p-2 bg-green-50 dark:bg-green-900/30 rounded-lg shrink-0"},[s("svg",{class:"w-4 h-4 sm:w-5 sm:h-5 text-green-600 dark:text-green-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"})])],-1)),s("div",$e,[s("p",Pe,c(t.name),1),s("p",Be,c(t.path),1)])]),(l(),n("svg",{class:re(["w-5 h-5 text-gray-400 transition-transform shrink-0 ml-2",{"rotate-180":t.expanded}]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[...a[7]||(a[7]=[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)])],2))],8,_e),s("button",{onClick:T(r=>S(t),["stop"]),disabled:i.value===`${t.path}::latest`,class:"mt-2 w-full px-3 py-1.5 text-xs sm:text-sm border border-blue-600 text-blue-600 dark:text-blue-400 rounded-md hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors disabled:opacity-50"},c(i.value===`${t.path}::latest`?"准备中...":"下载最新备份"),9,Me)]),t.expanded?(l(),n("div",Re,[t.loading?(l(),n("div",De,[...a[8]||(a[8]=[s("svg",{class:"animate-spin h-6 w-6 text-blue-600",fill:"none",viewBox:"0 0 24 24"},[s("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),s("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})],-1)])])):t.error?(l(),n("div",je,[oe(c(t.error)+" ",1),s("button",{onClick:r=>Y(t),class:"ml-2 text-blue-600 dark:text-blue-400 hover:underline"}," 重新输入密码 ",8,Ne)])):t.archives&&t.archives.length===0?(l(),n("div",ze," 该仓库没有存档 ")):(l(),n("div",Ve,[(l(!0),n(V,null,H(t.archives,(r,o)=>(l(),n("div",{key:r.name,class:"flex items-center justify-between px-4 sm:px-5 py-2.5 sm:py-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"},[s("div",Te,[s("p",Ae,c(r.name),1),s("p",Ee,c(Q(r.start)),1)]),s("button",{onClick:p=>X(t,o),disabled:i.value===`${t.path}::${o}`,class:"ml-2 sm:ml-3 px-2.5 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors disabled:opacity-50 shrink-0"},c(i.value===`${t.path}::${o}`?"准备中...":"下载"),9,Le)]))),128))]))])):R("",!0)]))),128))]))],64)):(l(),n("div",me,[a[4]||(a[4]=s("svg",{class:"mx-auto h-10 w-10 text-yellow-500 mb-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),s("p",xe,c(U.value),1)])),b.value?(l(),n("div",{key:4,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 px-4",onClick:T(F,["self"])},[s("div",Ue,[a[10]||(a[10]=s("h3",{class:"text-lg font-semibold text-gray-900 dark:text-white mb-1"}," 输入仓库密码 ",-1)),s("p",We,c(k.value?.name||k.value?.path),1),z.value?(l(),n("p",Fe,c(z.value),1)):R("",!0),s("form",{onSubmit:T(K,["prevent"])},[I(s("input",{ref_key:"passwordInput",ref:W,"onUpdate:modelValue":a[0]||(a[0]=t=>_.value=t),type:"password",autocomplete:"off",class:"w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition text-sm",placeholder:"Borg 仓库密码（无密码可留空）"},null,512),[[le,_.value]]),s("label",Se,[I(s("input",{"onUpdate:modelValue":a[1]||(a[1]=t=>B.value=t),type:"checkbox",class:"w-4 h-4 text-blue-600 bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500"},null,512),[[ne,B.value]]),a[9]||(a[9]=s("span",{class:"ml-2 text-sm text-gray-600 dark:text-gray-400"},"保存密码到浏览器",-1))]),s("div",He,[s("button",{type:"button",onClick:F,class:"px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"}," 取消 "),s("button",{type:"button",onClick:J,class:"px-4 py-2 text-sm text-gray-600 dark:text-gray-400 border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"}," 无密码 "),s("button",{type:"submit",disabled:!_.value,class:"px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors disabled:opacity-50"}," 确认 ",8,Ie)])],32)])])):R("",!0)])]),_:1}))}};export{Qe as default};
